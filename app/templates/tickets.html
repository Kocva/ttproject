{% extends 'base.html' %}

{% block title %}Заявки{% endblock %}

{% block content %}
<h1 class="mb-4">Система заявок</h1>

<div class="mb-3">
    <h2>Создать новую заявку</h2>
    <form id="ticket-form">
        <div class="mb-3">
            <input type="text" id="title" class="form-control" placeholder="Название">
        </div>
        <div class="mb-3">
            <input type="text" id="description" class="form-control" placeholder="Описание">
        </div>
        <div class="mb-3">
            <label for="client">Клиент:</label>
            <select id="client" class="form-select" onchange="loadTradePoints()">
                <option value="">Выберите клиента</option>
                {% for client in clients %}
                    <option value="{{ client.id }}">{{ client.company_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="trade_point">Торговая точка:</label>
            <select id="trade_point" class="form-select">
                <option value="">Выберите торговую точку</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="employee">Сотрудник:</label>
            <select id="employee" class="form-select">
                {% for employee in employees %}
                    <option value="{{ employee.id }}">{{ employee.name }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="button" class="btn btn-primary" onclick="createTicket()">Создать заявку</button>
    </form>
</div>

<div class="mb-4">
    <h2>Список заявок</h2>
    <ul id="ticket-list" class="list-group"></ul>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function getTickets() {

        let url = `/api/tickets`;

        // Добавляем параметры фильтрации


        const response = await fetch(url);
        const tickets = await response.json();
        const ticketList = document.getElementById('ticket-list');
        ticketList.innerHTML = '';
        const currentEmployeeName = "{{ currentEmployeeName }}";  // Flask-переменная передается как строка в JavaScript
        console.log("from web:",currentEmployeeName);
        
        tickets.forEach(ticket => {
        console.log("from ticket:", ticket.employee_name)
        ticketList.innerHTML += `
            <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <span><strong>${ticket.title}</strong> - <strong>Статус:</strong> ${ticket.status}</span>
                    <div>
                        ${ticket.employee_name === null ? 
                            
                            // Если ответственный сотрудник null, показываем кнопки "Взять в работу" и "Удалить"
                            `<button class="btn btn-sm btn-success me-2" onclick="takeTicket(${ticket.id})">Взять в работу</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTicket(${ticket.id})">Удалить</button>` :
                        ticket.employee_name !== currentEmployeeName ? 
                            // Если заявка у другого сотрудника, показываем только кнопку "Удалить"
                            `<button class="btn btn-sm btn-danger" onclick="deleteTicket(${ticket.id})">Удалить</button>` :
                        // Если заявка у текущего сотрудника, показываем кнопки "Изменить" и "Удалить"
                        
                        `<button class="btn btn-sm btn-warning me-2" onclick="editTicket(${ticket.id})">Изменить</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTicket(${ticket.id})">Удалить</button>`
                        }
                    </div>
                </div>
                <p><strong>Описание:</strong> ${ticket.description}</p>
                <p><strong>Ответственный сотрудник:</strong> ${ticket.employee_name ? ticket.employee_name : 'Не назначен'}</p>
                <p><strong>Компания:</strong> ${ticket.company_name}</p>
                <p><strong>Точка продаж:</strong> ${ticket.place_address || 'Не указано'}</p>
                <small class="text-muted">Создано: ${new Date(ticket.created_at).toLocaleString()}</small>
                <div id="edit-form-${ticket.id}" class="mt-3" style="display: none;">
                    <input type="text" class="form-control mb-2" id="edit-title-${ticket.id}" value="${ticket.title}" placeholder="Название">
                    <input type="text" class="form-control mb-2" id="edit-description-${ticket.id}" value="${ticket.description}" placeholder="Описание">
                    <input type="text" class="form-control mb-2" id="edit-status-${ticket.id}" value="${ticket.status}" placeholder="Статус">
                    <button class="btn btn-sm btn-primary" onclick="saveChanges(${ticket.id})">Сохранить</button>
                    <button class="btn btn-sm btn-secondary" onclick="cancelEdit(${ticket.id})">Отмена</button>
                </div>
            </li>
        `;
    });

    }

    async function loadTradePoints() {
        const clientId = document.getElementById('client').value;
        const tradePointSelect = document.getElementById('trade_point');  // Исправлено
        
        tradePointSelect.innerHTML = '<option value="">Выберите торговую точку</option>';
        
        if (!clientId) return;
        
        const response = await fetch(`/api/clients/${clientId}/trade_points`);
        const tradePoints = await response.json();
        
        tradePoints.forEach(point => {
            tradePointSelect.innerHTML += `<option value="${point.id}">${point.name}</option>`;
        });
    }

    async function takeTicket(ticketId) {
    const response = await fetch(`/api/tickets/${ticketId}/take`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json'
        }
    });

    if (response.ok) {
        alert('Заявка взята в работу!');
        getTickets();
    } else {
        alert('Ошибка при изменении статуса заявки.');
    }
}

    function editTicket(id) {
        const editForm = document.getElementById(`edit-form-${id}`);
        editForm.style.display = 'block';
    }

    function cancelEdit(id) {
        const editForm = document.getElementById(`edit-form-${id}`);
        editForm.style.display = 'none';
    }

    async function saveChanges(id) {
        const title = document.getElementById(`edit-title-${id}`).value;
        const description = document.getElementById(`edit-description-${id}`).value;
        const status = document.getElementById(`edit-status-${id}`).value;

        const response = await fetch(`/api/tickets/${id}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ title, description, status })
        });

        if (response.ok) {
            alert('Заявка обновлена!');
            getTickets();
        }
    }

    async function createTicket() {
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        const trade_point = document.getElementById('trade_point').value;
        const employeeId = document.getElementById('employee').value;
        const clientId = document.getElementById('client').value;
        const source = 'employee';

        const response = await fetch('/api/tickets', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ title, description, place_id: trade_point, employee_id: employeeId, client_id: clientId , source: source})
        });
        if (response.ok) {
            alert('Заявка создана!');
            getTickets();
        }
    }

    async function deleteTicket(id) {
        const response = await fetch(`/api/tickets/${id}`, {
            method: 'DELETE'
        });
        if (response.ok) {
            alert('Заявка удалена!');
            getTickets();
        }
    }

    window.onload = getTickets;
</script>
{% endblock %}
